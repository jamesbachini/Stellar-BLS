<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>BLS Privacy Demo</title>
<meta name="viewport" content="width=device-width,initial-scale=1">
<style>
  body{font-family:system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;background:#f7f9fb;margin:0;padding:0;color:#172b4d}
  .wrap{max-width:900px;margin:40px auto;padding:24px;background:white;border-radius:12px;box-shadow:0 6px 18px rgba(0,0,0,.1)}
  h1{margin-top:0;font-size:1.8rem}
  input[type=text]{width:100%;padding:8px 12px;font-size:1rem;border:1px solid #dfe1e6;border-radius:6px}
  button{cursor:pointer;background:#0064ff;color:#fff;border:none;padding:8px 18px;margin:4px 0;border-radius:6px;font-size:.95rem}
  button:disabled{opacity:.45;cursor:not-allowed}
  code{font-family:SFMono-Regular,Consolas,monospace;font-size:.85rem;background:#eef3ff;padding:1px 4px;border-radius:4px}
  .wallet{border:1px solid #dfe3e9;padding:16px;border-radius:8px;margin-top:12px}
  .good{color:#14853b;font-weight:600}
  .bad{color:#d91b11;font-weight:600}
</style>
</head>
<body>
<div class="wrap">
  <h1>BLS Privacy Demo</h1>
  <label>Contract Id (xdr / Hash):
    <input id="contractId" type="text" placeholder="Paste Soroban contract id here">
  </label>
  <button id="initBtn">Initialize (store group PK)</button>
  <p>
    Message to be signed: <code>Privacy is a right</code><br>
    SHA-256 payload: <code id="payload"></code>
  </p>
  <p>Flag on-chain: <span id="flagVal" class="bad">unknown</span></p>
  <h3>Wallets</h3>
  <div id="wallets"></div>
  <h3>Aggregate</h3>
  <p>Aggregated PK (uncompressed 96 bytes):<br><code id="aggPk"></code></p>
  <p>Aggregated Signature (uncompressed 192 bytes):<br><code id="aggSig"></code></p>
  <button id="sendBtn" disabled>Send Aggregated Tx (set_flag)</button>
</div>

<script type="module" src="https://cdn.jsdelivr.net/npm/@stellar/stellar-sdk/+esm"></script>
<script type="module">
import * as bls from "https://cdn.jsdelivr.net/npm/@noble/bls12-381/+esm";
import StellarSdk from "https://cdn.jsdelivr.net/npm/@stellar/stellar-sdk/+esm";

const { PointG1, PointG2 } = bls;
const RpcServer = StellarSdk.SorobanRpc?.Server || StellarSdk.rpc.Server;
const rpc = new RpcServer("https://soroban-testnet.stellar.org");
const networkPassphrase = StellarSdk.Networks.TESTNET;
const DST = "THRESHOLD-BLS-SIG-V1";
let source; // wallet to pay tx fees
const $ = id => document.getElementById(id);
const toHex = bytes => Array.from(bytes).map(b => b.toString(16).padStart(2,"0")).join("");
const sha256 = async msg =>
  new Uint8Array(await crypto.subtle.digest("SHA-256", new TextEncoder().encode(msg)));
const keyPairs = [];
for (let i = 0; i < 3; i++) {
  const kp = StellarSdk.Keypair.random();
  // Use raw 32-byte seed of secret key as BLS sk
  const rawSeed = kp.rawSecretKey().slice(0,32);
  const sk = rawSeed;
  const pkCompressed = await bls.getPublicKey(sk);
  const pkUncompressed = PointG1.fromHex(pkCompressed).toRawBytes(false);  // 96 bytes
  keyPairs.push({ stellar: kp, sk, pkUncompressed, signed:false, sigUncompressed:null });
}
let aggPkPoint = PointG1.ZERO;
keyPairs.forEach(w => { aggPkPoint = aggPkPoint.add(PointG1.fromHex(w.pkUncompressed));});
const aggPk96 = aggPkPoint.toRawBytes(false);
$("aggPk").textContent = toHex(aggPk96);
const payload32 = await sha256("Privacy is a right");
$("payload").textContent = toHex(payload32);

const walletsDiv = $("wallets");
keyPairs.forEach((w,idx)=>{
  const div = document.createElement("div");
  div.className="wallet";
  div.innerHTML = `
  <strong>Wallet #${idx+1}</strong><br>
  Stellar Pub: <code>${w.stellar.publicKey()}</code><br>
  BLS pk (96B): <code>${toHex(w.pkUncompressed)}</code><br>
  <button id="sign${idx}">Sign Tx</button> <span id="status${idx}">not signed</span>
  `;
  walletsDiv.appendChild(div);
  $("sign"+idx).onclick = async ()=>{
    if (w.signed) return;
    const sigCompressed = await bls.sign(payload32, w.sk, {DST});
    w.sigUncompressed = PointG2.fromHex(sigCompressed).toRawBytes(false); // 192B
    w.signed = true;
    $("status"+idx).textContent="signed";
    $("status"+idx).className="good";
    refreshAggregateSig();
  };
});

let aggregatedSig192 = null;
function refreshAggregateSig(){
  const signed = keyPairs.filter(w=>w.signed);
  if (signed.length<2){ $("aggSig").textContent="-- need â‰¥2 signatures --"; $("sendBtn").disabled=true; return;}

  let sigPoint = PointG2.ZERO;
  signed.forEach(w=>{ sigPoint = sigPoint.add(PointG2.fromHex(w.sigUncompressed));});
  aggregatedSig192 = sigPoint.toRawBytes(false);
  $("aggSig").textContent = toHex(aggregatedSig192);
  $("sendBtn").disabled = false;
}

async function loadFlag(contractId){
  if (!contractId || !source) return;
  try{
    const contract = new StellarSdk.Contract(contractId);
    const account = await rpc.getAccount(source.publicKey());
    const res = await rpc.simulateTransaction(
      new StellarSdk.TransactionBuilder(account,{networkPassphrase,fee:"100"})
        .addOperation(contract.call("get_flag"))
        .setTimeout(30).build()
    );
    const val = res.returnValue()?.toString()==="true";
    $("flagVal").textContent = val;
    $("flagVal").className = val?"good":"bad";
  }catch(e){ console.error(e);}
}

$("initBtn").onclick = async ()=>{
  const contractId = $("contractId").value.trim();
  if (!contractId){alert("Contract id required");return;}
  source = StellarSdk.Keypair.random();
  try{
    await rpc.getAccount(source.publicKey());
  }catch(_){
    await fetch(`https://friendbot-testnet.stellar.org?addr=${source.publicKey()}`);
    await new Promise(r => setTimeout(r, 10000));
    await rpc.getAccount(source.publicKey());
  }

  const contract = new StellarSdk.Contract(contractId);
  const account = await rpc.getAccount(source.publicKey());
  const tx = new StellarSdk.TransactionBuilder(account,{networkPassphrase,fee:"100"})
    .addOperation(contract.call("init", [...aggPk96])) // soroban client treats byte array arguments
    .setTimeout(30).build();
  tx.sign(source);
  try{
    const sendRes = await rpc.sendTransaction(tx);
    alert("init(): "+sendRes.hash);
    await loadFlag(contractId);
  }catch(e){alert("init failed "+e);}
};

$("sendBtn").onclick = async ()=>{
  const contractId = $("contractId").value.trim();
  if (!contractId){alert("Contract id required");return;}
  if (!aggregatedSig192){alert("Need aggregated signature");return;}
  const source = keyPairs[0].stellar;
  const contract = new StellarSdk.Contract(contractId);
  const account = await rpc.getAccount(source.publicKey());
  const tx = new StellarSdk.TransactionBuilder(account,{networkPassphrase,fee:"100"})
    .addOperation(contract.call("set_flag",
        [...payload32],
        [...aggregatedSig192]))
    .setTimeout(30).build();
  tx.sign(source);
  try{
    const {hash} = await rpc.sendTransaction(tx);
    alert("set_flag(): "+hash);
    await loadFlag(contractId);
  }catch(e){alert("set_flag failed "+e);}
};

$("contractId").oninput = ()=>loadFlag($("contractId").value.trim());
</script>
</body>
</html>