<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>Soroban - BLS12-381 Ring-Signature Demo</title>
<meta name="viewport" content="width=device-width,initial-scale=1">
<style>
  body{font-family:system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;background:#f5f7fb;margin:0;color:#172b4d}
  .wrap{max-width:960px;margin:40px auto;padding:24px;background:#fff;border-radius:12px;box-shadow:0 6px 18px rgba(0,0,0,.1)}
  h1{margin:0 0 20px;font-size:1.8rem}
  h2{margin:32px 0 12px;font-size:1.3rem}
  input[type=text]{width:100%;padding:8px 12px;font-size:1rem;border:1px solid #dfe1e6;border-radius:6px}
  textarea{width:100%;min-height:70px;padding:8px 12px;font-size:1rem;border:1px solid #dfe1e6;border-radius:6px}
  button{cursor:pointer;background:#0064ff;color:#fff;border:none;padding:8px 18px;margin:6px 4px;border-radius:6px;font-size:.95rem}
  button:disabled{opacity:.45;cursor:not-allowed}
  code{font-family:SFMono-Regular,Consolas,monospace;font-size:.85rem;background:#eef2ff;padding:1px 4px;border-radius:4px}
  .good{color:#128200;font-weight:600}
  .bad{color:#c90d0d;font-weight:600}
  .card{border:1px solid #dfe3e9;border-radius:8px;padding:14px;margin-top:12px;background:#fafbfc}
</style>
</head>
<body>
<div class="wrap">
  <h1>Ring-Signature Private Tx on Soroban</h1>

  <p>
    Contract&nbsp;Id (already deployed on test-net):<br>
    <input id="cid" value="CCGODMFRVEVNZJGMOY7LWN3DGLT65BK56Q5W5WQX6NPDX2QBJKOLF264">
  </p>

  <h2>Step&nbsp;1 – Compose a message</h2>
  <textarea id="msg">Free Roman Storm</textarea><br>
  <button id="genRing">Generate 3 key-pairs</button>

  <div id="ringArea"></div>

  <h2>Step&nbsp;2 – Choose signer &amp; build ring signature</h2>
  <p>
    Signer index (0-based):
    <input id="idx" type="text" style="width:40px" value="1">
    <button id="signBtn" disabled>Create signature</button>
  </p>
  <pre id="sigOut">signature not yet built</pre>

  <h2>Step&nbsp;3 – Ask contract to verify</h2>
  <button id="verifyBtn" disabled>Simulate verify()</button>
  <span id="verResult"></span>
</div>

<script type="module" src="https://cdn.jsdelivr.net/npm/@stellar/stellar-sdk/+esm"></script>
<script type="module">
/* ---------- helpers ---------- */
import * as bls from "https://cdn.jsdelivr.net/npm/@noble/bls12-381/+esm";
import StellarSdk from "https://cdn.jsdelivr.net/npm/@stellar/stellar-sdk/+esm";

const {PointG1, utils:U} = bls;
const CURVE_R = bls.CURVE.r;
const modR = x => ((x%CURVE_R)+CURVE_R)%CURVE_R;
const hex = arr => Array.from(arr).map(b=>b.toString(16).padStart(2,"0")).join("");
const toBytes = big => {
  let h = big.toString(16).padStart(64,"0").slice(-64);
  return Uint8Array.from(h.match(/.{2}/g).map(b=>parseInt(b,16)));
};
const sha256 = async d => new Uint8Array(await crypto.subtle.digest("SHA-256",d));

const $ = id => document.getElementById(id);
let ring=[];
let privs=[];
let sig=null;
let msgBytes=null;

$("genRing").onclick = async ()=>{
  ring=[]; privs=[];
  $("ringArea").innerHTML="";
  for(let i=0;i<3;i++){
    const sk = modR(BigInt("0x"+hex(U.randomBytes(32))));
    const pk = PointG1.BASE.multiply(sk).toRawBytes(false); // 96B
    ring.push(pk); privs.push(sk);
    $("ringArea").innerHTML += `<div class="card">Index ${i}<br>pk: <code>${hex(pk).slice(0,16)}…</code></div>`;
  }
  $("signBtn").disabled=false;
  $("verifyBtn").disabled=true;
  $("sigOut").textContent="signature not yet built";
  $("verResult").textContent="";
};

$("signBtn").onclick = async ()=>{
  try{
    msgBytes = new TextEncoder().encode($("msg").value);
    const n = ring.length;
    const signer = parseInt($("idx").value);
    if(isNaN(signer) || signer<0 || signer>=n) return alert("bad signer index");
    ring[signer] = PointG1.BASE.multiply(privs[signer]).toRawBytes(false);
    const randFr = ()=>modR(BigInt("0x"+hex(U.randomBytes(32))));
    const a  = randFr();
    const responses = Array.from({length:n},randFr);
    let base = new Uint8Array(ring.length*96 + msgBytes.length);
    ring.forEach((pk,i)=>base.set(pk,96*i));
    base.set(msgBytes,ring.length*96);
    const xs = PointG1.BASE.multiply(a).toRawBytes(false);
    let pre  = new Uint8Array(base.length + xs.length);
    pre.set(base); pre.set(xs,base.length);
    const c=[]; for(let i=0;i<n;i++) c[i]=0n;
    let idx=(signer+1)%n;
    c[idx]=modR(BigInt("0x"+hex(await sha256(pre))));
    while(idx!==signer){
      const r_i = responses[idx];
      const p_i = PointG1.fromHex(ring[idx]);
      const x1  = PointG1.BASE.multiply(r_i);
      const x2  = p_i.multiply(c[idx]);
      const xi  = x1.add(x2).toRawBytes(false);
      let pre2 = new Uint8Array(base.length + xi.length);
      pre2.set(base); pre2.set(xi,base.length);
      const ci1 = modR(BigInt("0x"+hex(await sha256(pre2))));
      idx=(idx+1)%n;
      c[idx]=ci1;
    }
    const rs = modR(a - c[signer]*privs[signer]);
    responses[signer]=rs;
    sig = {
      challenge: toBytes(c[0]),
      responses: responses.map(toBytes)
    };
    $("sigOut").textContent =
        `challenge : ${hex(sig.challenge)}\n`+
        `responses : [${responses.map(r=>hex(toBytes(r)).slice(0,10)+"…").join(", ")}]`;
    $("verifyBtn").disabled=false;
    $("verResult").textContent="";
  }catch(e){alert(e);}
};

$("verifyBtn").onclick = async ()=>{
  try{
    const cid = $("cid").value.trim();
    if(!cid) return alert("cid required");
    const B = StellarSdk.xdr.ScVal.scvBytes;
    const Vec = a => StellarSdk.xdr.ScVal.scvVec(a);
    const Sym = s => StellarSdk.xdr.ScVal.scvSymbol(s);
    const Map = entries => StellarSdk.xdr.ScVal.scvMap(entries.map(
      ([k,v])=> new StellarSdk.xdr.ScMapEntry({key:Sym(k),val:v})
    ));
    const ringVal = Vec(ring.map(pk=>B(pk)));
    const sigVal  = Map([
      ["challenge", B(sig.challenge)],
      ["responses", Vec(sig.responses.map(r=>B(r)))]
    ]);
    const msgVal  = B(msgBytes);
    const RpcServer = StellarSdk.SorobanRpc?.Server || StellarSdk.rpc.Server;
    const rpc = new RpcServer("https://soroban-testnet.stellar.org");
    const network = StellarSdk.Networks.TESTNET;
    const payer   = StellarSdk.Keypair.random();
    try{await rpc.getAccount(payer.publicKey());}
    catch{await fetch(`https://friendbot-testnet.stellar.org?addr=${payer.publicKey()}`);
          await new Promise(r=>setTimeout(r,4000));}
    const contract = new StellarSdk.Contract(cid);
    let tx = new StellarSdk.TransactionBuilder(
                await rpc.getAccount(payer.publicKey()),
               {fee:"100",networkPassphrase:network})
              .addOperation(contract.call("verify", msgVal, ringVal, sigVal))
              .setTimeout(30).build();
    const sim = await rpc.simulateTransaction(tx);
    console.log(sim.result)
    const ok  = StellarSdk.scValToNative(sim.result.retval);
    $("verResult").textContent = ok ? "✅  contract returned TRUE" : "❌  contract returned FALSE";
    $("verResult").className   = ok ? "good" : "bad";
  }catch(e){alert(e);}
};
</script>
</body>
</html>